<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Hello!</title>
    <meta name="description" content="description"/>
    <meta name="author" content="author" />
    <meta name="keywords" content="keywords" />
    <link rel="stylesheet" href="./stylesheet.css" type="text/css" />
    <style type="text/css">.body { width: auto; }</style>
  </head>
  <body>
    <h1>Page title</h1>
    <div class="main">
        <form>
            <label for="addTask">Add task</label><br>
            <input id="addTask" type="text"><br>
   
            <label for="deleteTask">Delete task (ID):</label><br>
            <input id="deleteTask" type="text"><br><br>
            <input id="submitBtn" type="submit">
        </form>
        
    </div>
  <script>  


  document.addEventListener("DOMContentLoaded", () => {


    async function submitForm(e) {
        e.preventDefault()
        const url = "http://127.0.0.1:5000/tasks"       

        const addTask = document.getElementById("addTask")
        let addTaskVal = addTask.value.trim();
        if (addTaskVal) {
            try {
                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({"title": addTaskVal, "done": false}),

                })
                if (!response.ok) {
                    console.warn("error")
                }
                const result = await response.json()
                addTask.value = ""; //reset input value to allow consecutive adding
                await getTasks()
                
            } catch(e) {
                console.log(e)
            }
        }
        const deleteTask = document.getElementById("deleteTask")
        let deleteTaskVal = deleteTask.value.trim();

        if (deleteTaskVal) {
            const id = parseInt(deleteTaskVal, 10);
            if (Number.isNaN(id)) return console.warn("Invalid id");

            try {
                const reponse =  await fetch(`http://127.0.0.1:5000/tasks/${id}`, {
                    method: "DELETE",
                });
                 if (!reponse.ok) {
                    // 404 from backend when id not found
                    console.warn("Delete failed:", res.status);
                        return;
                    }
                deleteTask.value = ""
                await getTasks() // refresh
            } catch(e) {
                console.warn(e)
            }
        }

        return
    }
    document.querySelector("form").addEventListener("submit", submitForm);
    async function getTasks(api) {
        const url = "http://127.0.0.1:5000/tasks"
        try {
            const response = await fetch(url)
            if (!response.ok) {
                console.warn("error")
            }
            const result = await response.json()
            const htmlBody = document.querySelector(".main");
            const taskList = document.getElementById("taskList")
            if (taskList) {
                ul = taskList
                ul.innerHTML = ""  //reset list before updating
                 result.forEach(task => {
                    const li = document.createElement("li")
                    li.textContent = "Task ID: " + task.id + " " + task.title + ': ' + task.done;
                    ul.appendChild(li)
                })

            } else {
                const ul = document.createElement("ul");
                ul.id = "taskList";
                htmlBody.appendChild(ul);

                result.forEach(task => {
                    const li = document.createElement("li")
                    li.textContent = "Task ID: " + task.id + " " + task.title + ': ' + task.done;
                    ul.appendChild(li)
                })
            }
            
            
        } catch(e) {
            console.log(e)
        }
    }
    getTasks()

});

  </script>
  </body>
</html>